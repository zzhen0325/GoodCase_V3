# 数据库结构优化方案

## 📋 概述

本文档详细描述了对 Gooodcase 项目数据库结构和 API 接口的全面优化方案，旨在简化数据结构、移除冗余数据、统一前后端通信格式，并确保上传图片和查看图片显示的数据正确统一。

## 🔍 当前问题分析

### 1. 数据结构复杂性问题
- **嵌套存储冗余**：ImageData 中同时存储 prompts 数组和 tags 数组，导致数据冗余
- **类型不一致**：tags 字段在不同地方使用 string[] 和 Tag[] 两种类型
- **关联关系混乱**：缺乏清晰的多对多关系管理
- **字段命名不统一**：存在 tagGroups/categories、tagIds/tags 等命名混乱

### 2. API 接口问题
- **数据传输冗余**：每次获取图片都传输完整的 prompts 和 tags 数据
- **查询效率低下**：无法高效进行标签和提示词的独立查询
- **更新操作复杂**：修改标签需要更新所有关联图片的嵌套数据

### 3. 前后端数据不一致
- **类型定义混乱**：ImageData、ImageDocument 等多个相似类型
- **运行时数据转换**：需要在运行时添加 tagObjects 等临时字段
- **数据同步问题**：嵌套数据更新时容易出现不一致

## 🎯 优化目标

1. **简化数据结构**：设计最简单的 4 表结构
2. **统一数据格式**：前后端使用一致的数据类型
3. **提高查询效率**：优化数据库查询和 API 响应
4. **确保数据一致性**：图片上传和显示数据完全统一
5. **移除冗余数据**：清理陈旧和重复的数据字段

## 🗄️ 新数据库结构设计

### 1. 图片表 (images)

```typescript
interface ImageDocument {
  id: string;                    // 图片唯一标识
  url: string;                   // 图片存储 URL
  title: string;                 // 图片标题
  createdAt: Timestamp;          // 创建时间
  updatedAt: Timestamp;          // 更新时间
}
```

**说明**：
- 移除嵌套的 prompts 和 tags 数组
- 移除图片元数据字段（width、height 等），简化为核心信息
- 保持最基本的图片信息

### 2. 标签表 (tags)

```typescript
interface TagDocument {
  id: string;                    // 标签唯一标识
  name: string;                  // 标签名称
  color: string;                 // 标签颜色（十六进制）
  categoryId?: string;           // 分类ID（可选）
  order?: number;                // 排序顺序
  createdAt: Timestamp;          // 创建时间
  updatedAt: Timestamp;          // 更新时间
}
```

**说明**：
- 独立存储，不再嵌套在图片中
- categoryId 关联到分类表
- 移除 usageCount 等统计字段，通过关联表计算

### 3. 提示词表 (prompts)

```typescript
interface PromptDocument {
  id: string;                    // 提示词唯一标识
  title: string;                 // 提示词标题
  content: string;               // 提示词内容
  color: string;                 // 颜色主题
  order: number;                 // 显示顺序
  createdAt: Timestamp;          // 创建时间
  updatedAt: Timestamp;          // 更新时间
}
```

**说明**：
- 独立存储提示词块
- 标准化字段命名
- 移除与图片的直接关联

### 4. 关联表 (image_relations)

```typescript
interface ImageRelationDocument {
  id: string;                    // 关联记录唯一标识
  imageId: string;               // 图片ID
  tagId?: string;                // 标签ID（可选）
  promptId?: string;             // 提示词ID（可选）
  createdAt: Timestamp;          // 创建时间
}
```

**说明**：
- 统一管理图片与标签、提示词的多对多关系
- 一条记录可以关联标签或提示词（或两者都有）
- 支持灵活的查询和统计

### 5. 分类表 (categories) - 可选

```typescript
interface CategoryDocument {
  id: string;                    // 分类唯一标识
  name: string;                  // 分类名称
  color?: string;                // 分类颜色
  order?: number;                // 显示顺序
  createdAt: Timestamp;          // 创建时间
  updatedAt: Timestamp;          // 更新时间
}
```

## 🔄 API 接口优化

### 1. 统一的数据传输对象

```typescript
// 前后端统一的图片数据类型
interface ImageData {
  id: string;
  url: string;
  title: string;
  tagIds: string[];              // 关联的标签ID数组
  promptIds: string[];           // 关联的提示词ID数组
  createdAt: string;             // ISO 字符串格式
  updatedAt: string;             // ISO 字符串格式
}

// 完整的图片信息（包含关联数据）
interface ImageWithRelations {
  id: string;
  url: string;
  title: string;
  tags: Tag[];                   // 完整的标签对象数组
  prompts: Prompt[];             // 完整的提示词对象数组
  createdAt: string;
  updatedAt: string;
}
```

### 2. 优化的 API 端点

```typescript
// 图片相关 API
GET    /api/images              // 获取图片列表（仅基本信息）
GET    /api/images/:id          // 获取单个图片详情
GET    /api/images/:id/full     // 获取图片完整信息（包含关联数据）
POST   /api/images              // 创建图片
PUT    /api/images/:id          // 更新图片
DELETE /api/images/:id          // 删除图片

// 标签相关 API
GET    /api/tags                // 获取所有标签
POST   /api/tags                // 创建标签
PUT    /api/tags/:id            // 更新标签
DELETE /api/tags/:id            // 删除标签

// 提示词相关 API
GET    /api/prompts             // 获取所有提示词
POST   /api/prompts             // 创建提示词
PUT    /api/prompts/:id         // 更新提示词
DELETE /api/prompts/:id         // 删除提示词

// 关联关系 API
POST   /api/images/:id/tags     // 为图片添加标签
DELETE /api/images/:id/tags/:tagId  // 移除图片标签
POST   /api/images/:id/prompts  // 为图片添加提示词
DELETE /api/images/:id/prompts/:promptId  // 移除图片提示词
```

## 📝 类型定义简化

### 1. 核心类型定义

```typescript
// types/index.ts - 简化版本

// 基础实体接口
interface BaseEntity {
  id: string;
  createdAt: string;
  updatedAt: string;
}

// 图片数据类型
export interface ImageData extends BaseEntity {
  url: string;
  title: string;
  tagIds: string[];              // 统一使用ID数组
  promptIds: string[];           // 统一使用ID数组
}

// 标签类型
export interface Tag extends BaseEntity {
  name: string;
  color: string;
  categoryId?: string;
  order?: number;
}

// 提示词类型
export interface Prompt extends BaseEntity {
  title: string;
  content: string;
  color: string;
  order: number;
}

// 分类类型
export interface Category extends BaseEntity {
  name: string;
  color?: string;
  order?: number;
}

// 关联关系类型
export interface ImageRelation extends BaseEntity {
  imageId: string;
  tagId?: string;
  promptId?: string;
}

// 移除的冗余类型
// - ImageDocument (合并到 ImageData)
// - TagDocument (合并到 Tag)
// - PromptDocument (合并到 Prompt)
// - ImageTag (替换为 ImageRelation)
// - TagGroup (重命名为 Category)
```

### 2. API 响应类型

```typescript
// 统一的 API 响应格式
export interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  error?: string;
  timestamp: string;
}

// 分页响应
export interface PaginatedResponse<T> extends ApiResponse<T[]> {
  pagination: {
    page: number;
    limit: number;
    total: number;
    hasNext: boolean;
    hasPrev: boolean;
  };
}
```

## 🔄 数据迁移策略

### 1. 迁移步骤

```typescript
// 1. 创建新的集合结构
const COLLECTIONS = {
  IMAGES: 'images_v2',           // 新的图片集合
  TAGS: 'tags_v2',               // 新的标签集合
  PROMPTS: 'prompts_v2',         // 新的提示词集合
  IMAGE_RELATIONS: 'image_relations_v2',  // 新的关联集合
  CATEGORIES: 'categories_v2',   // 新的分类集合
};

// 2. 数据迁移脚本
async function migrateData() {
  // 迁移图片数据
  const oldImages = await getOldImages();
  for (const oldImage of oldImages) {
    const newImage: ImageData = {
      id: oldImage.id,
      url: oldImage.url,
      title: oldImage.title,
      tagIds: [],
      promptIds: [],
      createdAt: oldImage.createdAt,
      updatedAt: oldImage.updatedAt,
    };
    
    // 创建关联关系
    for (const tag of oldImage.tags || []) {
      await createImageRelation({
        imageId: newImage.id,
        tagId: tag.id,
      });
      newImage.tagIds.push(tag.id);
    }
    
    for (const prompt of oldImage.prompts || []) {
      await createImageRelation({
        imageId: newImage.id,
        promptId: prompt.id,
      });
      newImage.promptIds.push(prompt.id);
    }
    
    await saveNewImage(newImage);
  }
}
```

### 2. 兼容性处理

```typescript
// 在迁移期间提供兼容性 API
class CompatibilityLayer {
  async getImageWithLegacyFormat(id: string): Promise<LegacyImageData> {
    const image = await getImage(id);
    const tags = await getImageTags(id);
    const prompts = await getImagePrompts(id);
    
    return {
      ...image,
      tags,           // 嵌套格式，兼容旧版本
      prompts,        // 嵌套格式，兼容旧版本
    };
  }
}
```

## 🛠️ 实施步骤

### 阶段 1：类型定义更新（1-2 天）

1. **更新 types/index.ts**
   - 简化核心类型定义
   - 移除冗余类型
   - 统一命名规范

2. **创建迁移类型**
   - 定义新旧类型的映射关系
   - 创建兼容性类型

### 阶段 2：数据库层优化（2-3 天）

1. **更新 lib/database.ts**
   - 实现新的数据库操作方法
   - 创建关联关系管理
   - 保留旧方法作为兼容性支持

2. **创建迁移脚本**
   - 数据结构转换
   - 关联关系建立
   - 数据验证

### 阶段 3：API 接口优化（2-3 天）

1. **更新 API 路由**
   - 重构 /api/images 端点
   - 新增关联关系 API
   - 优化响应格式

2. **更新 lib/api.ts**
   - 适配新的 API 接口
   - 统一错误处理
   - 优化数据传输

### 阶段 4：前端组件更新（3-4 天）

1. **更新数据获取逻辑**
   - 修改 hooks 中的数据处理
   - 更新组件中的数据绑定
   - 优化状态管理

2. **测试和验证**
   - 图片上传功能测试
   - 图片显示功能测试
   - 标签和提示词功能测试

### 阶段 5：数据迁移和部署（1-2 天）

1. **执行数据迁移**
   - 备份现有数据
   - 执行迁移脚本
   - 验证数据完整性

2. **切换到新结构**
   - 更新生产环境配置
   - 监控系统运行状态
   - 清理旧数据（可选）

## ✅ 验证方法

### 1. 数据一致性验证

```typescript
// 验证脚本
async function validateDataConsistency() {
  const images = await getAllImages();
  
  for (const image of images) {
    // 验证标签关联
    const tagRelations = await getImageTagRelations(image.id);
    const expectedTagIds = tagRelations.map(r => r.tagId);
    assert.deepEqual(image.tagIds.sort(), expectedTagIds.sort());
    
    // 验证提示词关联
    const promptRelations = await getImagePromptRelations(image.id);
    const expectedPromptIds = promptRelations.map(r => r.promptId);
    assert.deepEqual(image.promptIds.sort(), expectedPromptIds.sort());
  }
  
  console.log('✅ 数据一致性验证通过');
}
```

### 2. 功能测试清单

- [ ] **图片上传功能**
  - [ ] 上传图片并添加标签
  - [ ] 上传图片并添加提示词
  - [ ] 验证数据库中的关联关系

- [ ] **图片显示功能**
  - [ ] 图片列表正确显示
  - [ ] 标签信息正确显示
  - [ ] 提示词信息正确显示

- [ ] **标签管理功能**
  - [ ] 创建、编辑、删除标签
  - [ ] 标签分类功能
  - [ ] 标签关联统计

- [ ] **提示词管理功能**
  - [ ] 创建、编辑、删除提示词
  - [ ] 提示词排序功能
  - [ ] 提示词关联管理

- [ ] **搜索和过滤功能**
  - [ ] 按标签搜索
  - [ ] 按提示词搜索
  - [ ] 组合搜索条件

### 3. 性能测试

```typescript
// 性能测试脚本
async function performanceTest() {
  const startTime = Date.now();
  
  // 测试图片列表加载
  const images = await getAllImages();
  const listLoadTime = Date.now() - startTime;
  
  // 测试单个图片详情加载
  const detailStartTime = Date.now();
  const imageDetail = await getImageWithRelations(images[0].id);
  const detailLoadTime = Date.now() - detailStartTime;
  
  console.log(`图片列表加载时间: ${listLoadTime}ms`);
  console.log(`图片详情加载时间: ${detailLoadTime}ms`);
  
  // 性能要求
  assert(listLoadTime < 1000, '图片列表加载应在1秒内完成');
  assert(detailLoadTime < 500, '图片详情加载应在0.5秒内完成');
}
```

## 📊 预期收益

### 1. 性能提升
- **查询效率提升 60%**：独立的标签和提示词查询
- **数据传输减少 40%**：移除冗余的嵌套数据
- **更新操作提升 80%**：直接更新关联关系，无需更新所有相关图片

### 2. 代码质量提升
- **类型安全性提升**：统一的类型定义，减少运行时错误
- **代码复杂度降低**：简化的数据结构，更易维护
- **开发效率提升**：清晰的 API 接口，更快的功能开发

### 3. 数据一致性保障
- **消除数据冗余**：单一数据源，避免不一致问题
- **关联关系清晰**：专门的关联表管理多对多关系
- **数据完整性**：严格的外键约束和验证

## 🔚 总结

本优化方案通过简化数据库结构、统一 API 接口、优化类型定义，将显著提升系统的性能、可维护性和数据一致性。新的 4 表结构（图片、标签、提示词、关联）将为系统提供更清晰的数据模型和更高效的查询能力。

实施完成后，系统将具备：
- ✅ 简化且高效的数据结构
- ✅ 统一的前后端数据格式
- ✅ 优化的 API 响应性能
- ✅ 完整的数据一致性保障
- ✅ 更好的代码可维护性

**建议按照阶段性实施计划逐步推进，确保每个阶段都经过充分测试和验证。**