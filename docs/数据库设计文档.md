# Gooodcase æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“æ¦‚è¿°](#æ•°æ®åº“æ¦‚è¿°)
2. [é›†åˆç»“æ„è®¾è®¡](#é›†åˆç»“æ„è®¾è®¡)
3. [æ•°æ®å…³ç³»å›¾](#æ•°æ®å…³ç³»å›¾)
4. [ç´¢å¼•è®¾è®¡](#ç´¢å¼•è®¾è®¡)
5. [æ•°æ®æ“ä½œæ¨¡å¼](#æ•°æ®æ“ä½œæ¨¡å¼)
6. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [å®‰å…¨è§„åˆ™](#å®‰å…¨è§„åˆ™)

---

## æ•°æ®åº“æ¦‚è¿°

### ğŸ—„ï¸ æŠ€æœ¯é€‰å‹

- **æ•°æ®åº“**: Firebase Firestore (NoSQL æ–‡æ¡£æ•°æ®åº“)
- **å­˜å‚¨**: Firebase Storage (æ–‡ä»¶å­˜å‚¨æœåŠ¡)
- **å®æ—¶åŒæ­¥**: Firestore å®æ—¶ç›‘å¬å™¨
- **ç¦»çº¿æ”¯æŒ**: Firestore ç¦»çº¿æŒä¹…åŒ–

### ğŸ¯ è®¾è®¡åŸåˆ™

1. **éè§„èŒƒåŒ–è®¾è®¡**: ä¸ºäº†æŸ¥è¯¢æ€§èƒ½ï¼Œé€‚åº¦å†—ä½™æ•°æ®
2. **åµŒå¥—æ•°æ®**: ç›¸å…³æ•°æ®åµŒå¥—å­˜å‚¨ï¼Œå‡å°‘æŸ¥è¯¢æ¬¡æ•°
3. **å®æ—¶åŒæ­¥**: åˆ©ç”¨ Firestore çš„å®æ—¶ç‰¹æ€§
4. **æ‰å¹³åŒ–é›†åˆ**: é¿å…è¿‡æ·±çš„åµŒå¥—ç»“æ„
5. **ç´¢å¼•ä¼˜åŒ–**: æ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡ç´¢å¼•

---

## é›†åˆç»“æ„è®¾è®¡

### ğŸ“Š é›†åˆæ¦‚è§ˆ

```
Firestore Database
â”œâ”€â”€ images/              # å›¾ç‰‡é›†åˆ
â”œâ”€â”€ tagGroups/           # æ ‡ç­¾åˆ†ç»„é›†åˆ
â”œâ”€â”€ prompts/             # æç¤ºè¯é›†åˆ (é¢„ç•™)
â””â”€â”€ metadata/            # å…ƒæ•°æ®é›†åˆ (é¢„ç•™)
```

### ğŸ–¼ï¸ Images é›†åˆ

**é›†åˆè·¯å¾„**: `/images/{imageId}`

```typescript
interface ImageDocument {
  // åŸºæœ¬ä¿¡æ¯
  url: string;                    // å›¾ç‰‡ URL (Firebase Storage)
  title: string;                  // å›¾ç‰‡æ ‡é¢˜
  
  // å…³è”æ•°æ® (åµŒå¥—å­˜å‚¨)
  prompts: Prompt[];              // æç¤ºè¯æ•°ç»„
  tags: Tag[];                    // æ ‡ç­¾æ•°ç»„
  
  // å›¾ç‰‡å…ƒæ•°æ®
  width: number;                  // å›¾ç‰‡å®½åº¦ (åƒç´ )
  height: number;                 // å›¾ç‰‡é«˜åº¦ (åƒç´ )
  fileSize: number;               // æ–‡ä»¶å¤§å° (å­—èŠ‚)
  format: string;                 // æ–‡ä»¶æ ¼å¼ (jpg, png, etc.)
  colorSpace: string;             // é¢œè‰²ç©ºé—´ (sRGB, etc.)
  hasTransparency: boolean;       // æ˜¯å¦æœ‰é€æ˜é€šé“
  
  // æ—¶é—´æˆ³
  createdAt: Timestamp;           // åˆ›å»ºæ—¶é—´
  updatedAt: Timestamp;           // æ›´æ–°æ—¶é—´
}
```

**ç¤ºä¾‹æ–‡æ¡£**:
```json
{
  "url": "https://firebasestorage.googleapis.com/v0/b/project/o/images%2Fexample.jpg",
  "title": "ç¾ä¸½çš„é£æ™¯ç…§ç‰‡",
  "prompts": [
    {
      "id": "prompt_1",
      "title": "é£æ ¼",
      "content": "å†™å®é£æ ¼ï¼Œé«˜æ¸…ç”»è´¨",
      "color": "#3b82f6",
      "order": 0
    }
  ],
  "tags": [
    {
      "id": "tag_1",
      "name": "é£æ™¯",
      "color": "#22c55e",
      "groupId": "group_nature",
      "usageCount": 15
    }
  ],
  "width": 1920,
  "height": 1080,
  "fileSize": 2048576,
  "format": "jpeg",
  "colorSpace": "sRGB",
  "hasTransparency": false,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

### ğŸ·ï¸ TagGroups é›†åˆ

**é›†åˆè·¯å¾„**: `/tagGroups/{groupId}`

```typescript
interface TagGroupDocument {
  // åŸºæœ¬ä¿¡æ¯
  name: string;                   // åˆ†ç»„åç§°
  color: string;                  // åˆ†ç»„é¢œè‰² (åå…­è¿›åˆ¶)
  description?: string;           // åˆ†ç»„æè¿° (å¯é€‰)
  
  // æ’åºå’Œç»Ÿè®¡
  order: number;                  // æ˜¾ç¤ºé¡ºåº
  tagCount: number;               // åŒ…å«çš„æ ‡ç­¾æ•°é‡
  
  // æ—¶é—´æˆ³
  createdAt: Timestamp;           // åˆ›å»ºæ—¶é—´
  updatedAt: Timestamp;           // æ›´æ–°æ—¶é—´
}
```

**ç¤ºä¾‹æ–‡æ¡£**:
```json
{
  "name": "è‡ªç„¶é£å…‰",
  "color": "#22c55e",
  "description": "è‡ªç„¶é£æ™¯ç›¸å…³çš„æ ‡ç­¾åˆ†ç»„",
  "order": 1,
  "tagCount": 8,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

### ğŸ’­ Prompts é›†åˆ (é¢„ç•™)

**é›†åˆè·¯å¾„**: `/prompts/{promptId}`

```typescript
interface PromptDocument {
  // åŸºæœ¬ä¿¡æ¯
  title: string;                  // æç¤ºè¯æ ‡é¢˜
  content: string;                // æç¤ºè¯å†…å®¹
  color: string;                  // é¢œè‰²ä¸»é¢˜
  
  // æ’åº
  order: number;                  // æ˜¾ç¤ºé¡ºåº
  
  // æ—¶é—´æˆ³
  createdAt: Timestamp;           // åˆ›å»ºæ—¶é—´
  updatedAt: Timestamp;           // æ›´æ–°æ—¶é—´
}
```

### ğŸ“ˆ Metadata é›†åˆ (é¢„ç•™)

**é›†åˆè·¯å¾„**: `/metadata/stats`

```typescript
interface MetadataDocument {
  // ç»Ÿè®¡ä¿¡æ¯
  totalImages: number;            // å›¾ç‰‡æ€»æ•°
  totalTags: number;              // æ ‡ç­¾æ€»æ•°
  totalPrompts: number;           // æç¤ºè¯æ€»æ•°
  
  // å­˜å‚¨ç»Ÿè®¡
  totalStorageUsed: number;       // å·²ä½¿ç”¨å­˜å‚¨ç©ºé—´ (å­—èŠ‚)
  
  // æ—¶é—´æˆ³
  lastUpdated: Timestamp;         // æœ€åæ›´æ–°æ—¶é—´
}
```

---

## æ•°æ®å…³ç³»å›¾

### ğŸ”— å®ä½“å…³ç³»å›¾ (ERD)

```mermaid
erDiagram
    IMAGES {
        string id PK "æ–‡æ¡£ID"
        string url "å›¾ç‰‡URL"
        string title "å›¾ç‰‡æ ‡é¢˜"
        array prompts "åµŒå¥—æç¤ºè¯"
        array tags "åµŒå¥—æ ‡ç­¾"
        number width "å›¾ç‰‡å®½åº¦"
        number height "å›¾ç‰‡é«˜åº¦"
        number fileSize "æ–‡ä»¶å¤§å°"
        string format "æ–‡ä»¶æ ¼å¼"
        string colorSpace "é¢œè‰²ç©ºé—´"
        boolean hasTransparency "é€æ˜é€šé“"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
        timestamp updatedAt "æ›´æ–°æ—¶é—´"
    }
    
    TAG_GROUPS {
        string id PK "æ–‡æ¡£ID"
        string name "åˆ†ç»„åç§°"
        string color "åˆ†ç»„é¢œè‰²"
        string description "åˆ†ç»„æè¿°"
        number order "æ˜¾ç¤ºé¡ºåº"
        number tagCount "æ ‡ç­¾æ•°é‡"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
        timestamp updatedAt "æ›´æ–°æ—¶é—´"
    }
    
    PROMPTS {
        string id PK "æ–‡æ¡£ID"
        string title "æç¤ºè¯æ ‡é¢˜"
        string content "æç¤ºè¯å†…å®¹"
        string color "é¢œè‰²ä¸»é¢˜"
        number order "æ˜¾ç¤ºé¡ºåº"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
        timestamp updatedAt "æ›´æ–°æ—¶é—´"
    }
    
    EMBEDDED_TAGS {
        string id "æ ‡ç­¾ID"
        string name "æ ‡ç­¾åç§°"
        string color "æ ‡ç­¾é¢œè‰²"
        string groupId FK "åˆ†ç»„ID"
        number usageCount "ä½¿ç”¨æ¬¡æ•°"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
        timestamp updatedAt "æ›´æ–°æ—¶é—´"
    }
    
    EMBEDDED_PROMPTS {
        string id "æç¤ºè¯ID"
        string title "æç¤ºè¯æ ‡é¢˜"
        string content "æç¤ºè¯å†…å®¹"
        string color "é¢œè‰²ä¸»é¢˜"
        number order "æ˜¾ç¤ºé¡ºåº"
    }
    
    IMAGES ||--o{ EMBEDDED_TAGS : "åŒ…å«"
    IMAGES ||--o{ EMBEDDED_PROMPTS : "åŒ…å«"
    TAG_GROUPS ||--o{ EMBEDDED_TAGS : "åˆ†ç»„"
```

### ğŸ”„ æ•°æ®æµå…³ç³»å›¾

```mermaid
graph TD
    A[ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡] --> B[Firebase Storage]
    B --> C[è·å–ä¸‹è½½URL]
    C --> D[åˆ›å»ºå›¾ç‰‡æ–‡æ¡£]
    D --> E[Images é›†åˆ]
    
    F[ç”¨æˆ·æ·»åŠ æ ‡ç­¾] --> G[åµŒå…¥åˆ°å›¾ç‰‡æ–‡æ¡£]
    G --> E
    
    H[åˆ›å»ºæ ‡ç­¾åˆ†ç»„] --> I[TagGroups é›†åˆ]
    I --> J[æ ‡ç­¾å…³è”åˆ†ç»„ID]
    J --> G
    
    K[å®æ—¶ç›‘å¬å™¨] --> E
    K --> I
    E --> L[å®¢æˆ·ç«¯çŠ¶æ€æ›´æ–°]
    I --> L
    
    M[æ ‡ç­¾ç»Ÿè®¡] --> N[ä»å›¾ç‰‡æ–‡æ¡£æå–]
    N --> O[åŠ¨æ€è®¡ç®—ä½¿ç”¨æ¬¡æ•°]
    O --> L
```

---

## ç´¢å¼•è®¾è®¡

### ğŸ“Š å¤åˆç´¢å¼•

#### 1. Images é›†åˆç´¢å¼•

```javascript
// æŒ‰åˆ›å»ºæ—¶é—´æ’åº (é»˜è®¤æŸ¥è¯¢)
{
  collection: 'images',
  fields: [
    { field: 'createdAt', order: 'desc' }
  ]
}

// æŒ‰æ›´æ–°æ—¶é—´æ’åº
{
  collection: 'images',
  fields: [
    { field: 'updatedAt', order: 'desc' }
  ]
}

// æŒ‰æ ‡é¢˜æœç´¢ + æ—¶é—´æ’åº
{
  collection: 'images',
  fields: [
    { field: 'title', order: 'asc' },
    { field: 'createdAt', order: 'desc' }
  ]
}

// æ ‡ç­¾è¿‡æ»¤ + æ—¶é—´æ’åº (æ•°ç»„åŒ…å«æŸ¥è¯¢)
{
  collection: 'images',
  fields: [
    { field: 'tags.name', arrayConfig: 'contains' },
    { field: 'createdAt', order: 'desc' }
  ]
}
```

#### 2. TagGroups é›†åˆç´¢å¼•

```javascript
// æŒ‰æ˜¾ç¤ºé¡ºåºæ’åº
{
  collection: 'tagGroups',
  fields: [
    { field: 'order', order: 'asc' }
  ]
}

// æŒ‰åç§°æœç´¢
{
  collection: 'tagGroups',
  fields: [
    { field: 'name', order: 'asc' }
  ]
}
```

### ğŸ” æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

#### 1. åˆ†é¡µæŸ¥è¯¢
```typescript
// ä½¿ç”¨ startAfter è¿›è¡Œåˆ†é¡µ
const query = query(
  collection(db, 'images'),
  orderBy('createdAt', 'desc'),
  limit(20),
  startAfter(lastDoc)
);
```

#### 2. æ ‡ç­¾è¿‡æ»¤æŸ¥è¯¢
```typescript
// ä½¿ç”¨ array-contains-any æŸ¥è¯¢å¤šä¸ªæ ‡ç­¾
const query = query(
  collection(db, 'images'),
  where('tags.name', 'array-contains-any', selectedTags),
  orderBy('createdAt', 'desc')
);
```

#### 3. æ–‡æœ¬æœç´¢ (å®¢æˆ·ç«¯è¿‡æ»¤)
```typescript
// Firestore ä¸æ”¯æŒå…¨æ–‡æœç´¢ï¼Œåœ¨å®¢æˆ·ç«¯è¿›è¡Œè¿‡æ»¤
const filteredImages = images.filter(image => 
  image.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
  image.tags.some(tag => 
    tag.name.toLowerCase().includes(searchQuery.toLowerCase())
  )
);
```

---

## æ•°æ®æ“ä½œæ¨¡å¼

### ğŸ”„ å®æ—¶ç›‘å¬æ¨¡å¼

#### 1. å›¾ç‰‡æ•°æ®ç›‘å¬
```typescript
// ç›‘å¬å›¾ç‰‡é›†åˆå˜åŒ–
const unsubscribe = onSnapshot(
  query(collection(db, 'images'), orderBy('createdAt', 'desc')),
  (snapshot) => {
    const images = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    setImages(images);
  },
  (error) => {
    console.error('ç›‘å¬é”™è¯¯:', error);
  }
);
```

#### 2. æ ‡ç­¾æ•°æ®æå–
```typescript
// ä»å›¾ç‰‡æ•°æ®ä¸­æå–æ ‡ç­¾
const extractTags = (images: ImageData[]) => {
  const tagMap = new Map<string, Tag>();
  
  images.forEach(image => {
    image.tags.forEach(tag => {
      if (tagMap.has(tag.name)) {
        const existingTag = tagMap.get(tag.name)!;
        existingTag.usageCount = (existingTag.usageCount || 0) + 1;
      } else {
        tagMap.set(tag.name, { ...tag, usageCount: 1 });
      }
    });
  });
  
  return Array.from(tagMap.values())
    .sort((a, b) => (b.usageCount || 0) - (a.usageCount || 0));
};
```

### ğŸ“ å†™å…¥æ“ä½œæ¨¡å¼

#### 1. å•æ–‡æ¡£å†™å…¥
```typescript
// æ·»åŠ æ–°å›¾ç‰‡
const addImage = async (imageData: Omit<ImageDocument, 'id'>) => {
  const docRef = await addDoc(collection(db, 'images'), {
    ...imageData,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
  return docRef.id;
};
```

#### 2. æ‰¹é‡å†™å…¥
```typescript
// æ‰¹é‡æ“ä½œ
const batchWrite = async (operations: BatchOperation[]) => {
  const batch = writeBatch(db);
  
  operations.forEach(op => {
    const docRef = doc(db, op.collection, op.id);
    if (op.type === 'set') {
      batch.set(docRef, op.data);
    } else if (op.type === 'update') {
      batch.update(docRef, op.data);
    } else if (op.type === 'delete') {
      batch.delete(docRef);
    }
  });
  
  await batch.commit();
};
```

#### 3. äº‹åŠ¡æ“ä½œ
```typescript
// äº‹åŠ¡æ›´æ–°
const updateImageWithTransaction = async (imageId: string, updates: Partial<ImageDocument>) => {
  await runTransaction(db, async (transaction) => {
    const imageRef = doc(db, 'images', imageId);
    const imageDoc = await transaction.get(imageRef);
    
    if (!imageDoc.exists()) {
      throw new Error('å›¾ç‰‡ä¸å­˜åœ¨');
    }
    
    transaction.update(imageRef, {
      ...updates,
      updatedAt: serverTimestamp()
    });
  });
};
```

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ğŸš€ æŸ¥è¯¢ä¼˜åŒ–

#### 1. ç´¢å¼•ä¼˜åŒ–
- ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºå¤åˆç´¢å¼•
- é¿å…ä¸ç­‰å¼æŸ¥è¯¢çš„æ€§èƒ½é—®é¢˜
- ä½¿ç”¨æ•°ç»„åŒ…å«æŸ¥è¯¢è¿›è¡Œæ ‡ç­¾è¿‡æ»¤

#### 2. åˆ†é¡µç­–ç•¥
```typescript
// æ¸¸æ ‡åˆ†é¡µ (æ¨è)
const loadNextPage = async (lastDoc?: DocumentSnapshot) => {
  let q = query(
    collection(db, 'images'),
    orderBy('createdAt', 'desc'),
    limit(20)
  );
  
  if (lastDoc) {
    q = query(q, startAfter(lastDoc));
  }
  
  const snapshot = await getDocs(q);
  return {
    docs: snapshot.docs,
    lastDoc: snapshot.docs[snapshot.docs.length - 1]
  };
};
```

#### 3. æ•°æ®é¢„åŠ è½½
```typescript
// é¢„åŠ è½½ä¸‹ä¸€é¡µæ•°æ®
const preloadNextPage = async (currentLastDoc: DocumentSnapshot) => {
  const nextPageQuery = query(
    collection(db, 'images'),
    orderBy('createdAt', 'desc'),
    startAfter(currentLastDoc),
    limit(20)
  );
  
  // åœ¨åå°é¢„åŠ è½½
  getDocs(nextPageQuery).then(snapshot => {
    // ç¼“å­˜åˆ°æœ¬åœ°çŠ¶æ€
    cacheNextPageData(snapshot.docs);
  });
};
```

### ğŸ’¾ ç¼“å­˜ç­–ç•¥

#### 1. ç¦»çº¿æŒä¹…åŒ–
```typescript
// å¯ç”¨ç¦»çº¿æŒä¹…åŒ–
import { enableNetwork, disableNetwork } from 'firebase/firestore';

// å¯ç”¨ç¦»çº¿æ”¯æŒ
const enableOfflineSupport = async () => {
  try {
    await enableNetwork(db);
    console.log('ç¦»çº¿æ”¯æŒå·²å¯ç”¨');
  } catch (error) {
    console.error('å¯ç”¨ç¦»çº¿æ”¯æŒå¤±è´¥:', error);
  }
};
```

#### 2. å†…å­˜ç¼“å­˜
```typescript
// ç®€å•çš„å†…å­˜ç¼“å­˜å®ç°
class DataCache {
  private cache = new Map<string, { data: any; timestamp: number }>();
  private ttl = 5 * 60 * 1000; // 5åˆ†é’Ÿè¿‡æœŸ
  
  set(key: string, data: any) {
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }
  
  get(key: string) {
    const cached = this.cache.get(key);
    if (!cached) return null;
    
    if (Date.now() - cached.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return cached.data;
  }
}
```

### ğŸ“Š ç›‘æ§å’Œåˆ†æ

#### 1. æŸ¥è¯¢æ€§èƒ½ç›‘æ§
```typescript
// æŸ¥è¯¢æ€§èƒ½ç›‘æ§
const monitorQuery = async (queryName: string, queryFn: () => Promise<any>) => {
  const startTime = performance.now();
  
  try {
    const result = await queryFn();
    const endTime = performance.now();
    
    console.log(`æŸ¥è¯¢ ${queryName} è€—æ—¶: ${endTime - startTime}ms`);
    
    // å‘é€æ€§èƒ½æ•°æ®åˆ°ç›‘æ§æœåŠ¡
    sendPerformanceMetric(queryName, endTime - startTime);
    
    return result;
  } catch (error) {
    console.error(`æŸ¥è¯¢ ${queryName} å¤±è´¥:`, error);
    throw error;
  }
};
```

#### 2. æ•°æ®ä½¿ç”¨ç»Ÿè®¡
```typescript
// ç»Ÿè®¡æ•°æ®ä½¿ç”¨æƒ…å†µ
const trackDataUsage = () => {
  const stats = {
    totalReads: 0,
    totalWrites: 0,
    cacheHits: 0,
    cacheMisses: 0
  };
  
  // åœ¨æŸ¥è¯¢æ—¶æ›´æ–°ç»Ÿè®¡
  const incrementReads = () => stats.totalReads++;
  const incrementWrites = () => stats.totalWrites++;
  
  return { stats, incrementReads, incrementWrites };
};
```

---

## å®‰å…¨è§„åˆ™

### ğŸ›¡ï¸ Firestore å®‰å…¨è§„åˆ™

#### 1. å¼€å‘ç¯å¢ƒè§„åˆ™
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // å¼€å‘ç¯å¢ƒ - å…è®¸æ‰€æœ‰è¯»å†™æ“ä½œ
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
```

#### 2. ç”Ÿäº§ç¯å¢ƒè§„åˆ™ (ç¤ºä¾‹)
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // å›¾ç‰‡é›†åˆ
    match /images/{imageId} {
      allow read: if true; // å…è®¸æ‰€æœ‰äººè¯»å–
      allow write: if request.auth != null; // éœ€è¦è®¤è¯æ‰èƒ½å†™å…¥
      
      // éªŒè¯æ•°æ®ç»“æ„
      allow create: if validateImageData(request.resource.data);
      allow update: if validateImageData(request.resource.data)
                   && resource.data.createdAt == request.resource.data.createdAt;
    }
    
    // æ ‡ç­¾åˆ†ç»„é›†åˆ
    match /tagGroups/{groupId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // éªŒè¯å‡½æ•°
    function validateImageData(data) {
      return data.keys().hasAll(['url', 'title', 'prompts', 'tags', 'createdAt', 'updatedAt'])
             && data.url is string
             && data.title is string
             && data.prompts is list
             && data.tags is list;
    }
  }
}
```

### ğŸ”’ Firebase Storage å®‰å…¨è§„åˆ™

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // å›¾ç‰‡æ–‡ä»¶
    match /images/{imageId} {
      allow read: if true; // å…è®¸æ‰€æœ‰äººè¯»å–å›¾ç‰‡
      allow write: if request.auth != null // éœ€è¦è®¤è¯æ‰èƒ½ä¸Šä¼ 
                   && request.resource.size < 10 * 1024 * 1024 // é™åˆ¶æ–‡ä»¶å¤§å° 10MB
                   && request.resource.contentType.matches('image/.*'); // åªå…è®¸å›¾ç‰‡æ–‡ä»¶
    }
  }
}
```

### ğŸ” å®¢æˆ·ç«¯å®‰å…¨æªæ–½

#### 1. è¾“å…¥éªŒè¯
```typescript
// å›¾ç‰‡æ•°æ®éªŒè¯
const validateImageData = (data: any): data is ImageDocument => {
  return (
    typeof data.url === 'string' &&
    typeof data.title === 'string' &&
    Array.isArray(data.prompts) &&
    Array.isArray(data.tags) &&
    typeof data.width === 'number' &&
    typeof data.height === 'number'
  );
};

// æ–‡ä»¶ç±»å‹éªŒè¯
const validateImageFile = (file: File): boolean => {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  const maxSize = 10 * 1024 * 1024; // 10MB
  
  return (
    allowedTypes.includes(file.type) &&
    file.size <= maxSize
  );
};
```

#### 2. XSS é˜²æŠ¤
```typescript
// HTML å†…å®¹æ¸…ç†
import DOMPurify from 'dompurify';

const sanitizeHtml = (html: string): string => {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong'],
    ALLOWED_ATTR: []
  });
};

// ç”¨æˆ·è¾“å…¥æ¸…ç†
const sanitizeUserInput = (input: string): string => {
  return input
    .trim()
    .replace(/[<>"'&]/g, (char) => {
      const entities: Record<string, string> = {
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#x27;',
        '&': '&amp;'
      };
      return entities[char] || char;
    });
};
```

---

## æ•°æ®è¿ç§»å’Œå¤‡ä»½

### ğŸ“¦ æ•°æ®å¯¼å‡º

```typescript
// å®Œæ•´æ•°æ®å¯¼å‡º
const exportAllData = async (): Promise<ExportData> => {
  const [imagesResult, tagGroupsResult] = await Promise.all([
    getAllImages(),
    getAllTagGroups()
  ]);
  
  if (!imagesResult.success || !tagGroupsResult.success) {
    throw new Error('æ•°æ®å¯¼å‡ºå¤±è´¥');
  }
  
  return {
    version: '1.0',
    exportDate: new Date().toISOString(),
    images: imagesResult.data || [],
    tagGroups: tagGroupsResult.data || [],
    metadata: {
      totalImages: imagesResult.data?.length || 0,
      totalTagGroups: tagGroupsResult.data?.length || 0
    }
  };
};
```

### ğŸ“¥ æ•°æ®å¯¼å…¥

```typescript
// æ‰¹é‡æ•°æ®å¯¼å…¥
const importData = async (data: ExportData): Promise<BatchResult> => {
  const batch = writeBatch(db);
  let imported = 0;
  let failed = 0;
  
  // å¯¼å…¥å›¾ç‰‡æ•°æ®
  for (const image of data.images) {
    try {
      const docRef = doc(collection(db, 'images'));
      batch.set(docRef, {
        ...image,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      imported++;
    } catch (error) {
      console.error('å¯¼å…¥å›¾ç‰‡å¤±è´¥:', error);
      failed++;
    }
  }
  
  // å¯¼å…¥æ ‡ç­¾åˆ†ç»„æ•°æ®
  for (const tagGroup of data.tagGroups || []) {
    try {
      const docRef = doc(collection(db, 'tagGroups'));
      batch.set(docRef, {
        ...tagGroup,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      imported++;
    } catch (error) {
      console.error('å¯¼å…¥æ ‡ç­¾åˆ†ç»„å¤±è´¥:', error);
      failed++;
    }
  }
  
  await batch.commit();
  
  return {
    imported,
    failed,
    total: imported + failed
  };
};
```

### ğŸ”„ å¢é‡å¤‡ä»½

```typescript
// å¢é‡å¤‡ä»½ (åŸºäºæ—¶é—´æˆ³)
const incrementalBackup = async (lastBackupTime: Date): Promise<ExportData> => {
  const imagesQuery = query(
    collection(db, 'images'),
    where('updatedAt', '>', Timestamp.fromDate(lastBackupTime))
  );
  
  const tagGroupsQuery = query(
    collection(db, 'tagGroups'),
    where('updatedAt', '>', Timestamp.fromDate(lastBackupTime))
  );
  
  const [imagesSnapshot, tagGroupsSnapshot] = await Promise.all([
    getDocs(imagesQuery),
    getDocs(tagGroupsQuery)
  ]);
  
  return {
    version: '1.0',
    exportDate: new Date().toISOString(),
    isIncremental: true,
    lastBackupTime: lastBackupTime.toISOString(),
    images: imagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
    tagGroups: tagGroupsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
    metadata: {
      totalImages: imagesSnapshot.docs.length,
      totalTagGroups: tagGroupsSnapshot.docs.length
    }
  };
};
```

---

## æ•…éšœæ’é™¤

### ğŸ”§ å¸¸è§é—®é¢˜

#### 1. è¿æ¥é—®é¢˜
```typescript
// æ£€æŸ¥ Firestore è¿æ¥çŠ¶æ€
const checkFirestoreConnection = async (): Promise<boolean> => {
  try {
    const testDoc = doc(db, 'test', 'connection');
    await getDoc(testDoc);
    return true;
  } catch (error) {
    console.error('Firestore è¿æ¥å¤±è´¥:', error);
    return false;
  }
};
```

#### 2. æƒé™é—®é¢˜
```typescript
// æ£€æŸ¥æƒé™
const checkPermissions = async (): Promise<{ read: boolean; write: boolean }> => {
  const permissions = { read: false, write: false };
  
  try {
    // æµ‹è¯•è¯»æƒé™
    await getDocs(query(collection(db, 'images'), limit(1)));
    permissions.read = true;
  } catch (error) {
    console.error('è¯»æƒé™æ£€æŸ¥å¤±è´¥:', error);
  }
  
  try {
    // æµ‹è¯•å†™æƒé™
    const testDoc = doc(collection(db, 'test'));
    await setDoc(testDoc, { test: true });
    await deleteDoc(testDoc);
    permissions.write = true;
  } catch (error) {
    console.error('å†™æƒé™æ£€æŸ¥å¤±è´¥:', error);
  }
  
  return permissions;
};
```

#### 3. æ€§èƒ½é—®é¢˜
```typescript
// æŸ¥è¯¢æ€§èƒ½åˆ†æ
const analyzeQueryPerformance = async () => {
  const queries = [
    { name: 'è·å–æœ€æ–°å›¾ç‰‡', fn: () => getDocs(query(collection(db, 'images'), orderBy('createdAt', 'desc'), limit(20))) },
    { name: 'è·å–æ ‡ç­¾åˆ†ç»„', fn: () => getDocs(query(collection(db, 'tagGroups'), orderBy('order'))) }
  ];
  
  for (const { name, fn } of queries) {
    const startTime = performance.now();
    try {
      await fn();
      const endTime = performance.now();
      console.log(`${name}: ${endTime - startTime}ms`);
    } catch (error) {
      console.error(`${name} å¤±è´¥:`, error);
    }
  }
};
```

---

## ç‰ˆæœ¬å†å²

### v1.0
- åˆå§‹æ•°æ®åº“è®¾è®¡
- åŸºç¡€é›†åˆç»“æ„
- å®æ—¶ç›‘å¬åŠŸèƒ½
- æ•°æ®å¯¼å…¥å¯¼å‡º

### v1.1 (å½“å‰ç‰ˆæœ¬)
- æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†ä¼˜åŒ–
- IndexedDB schema å‡çº§ (v6)
- æ•°æ®å¯¼å‡ºæ ¼å¼å‡çº§ (v2.1)
- ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥

### æœªæ¥ç‰ˆæœ¬è§„åˆ’

#### v1.2
- æ·»åŠ å…¨æ–‡æœç´¢æ”¯æŒ (Algolia é›†æˆ)
- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- å¢åŠ æ•°æ®ç»Ÿè®¡åŠŸèƒ½

#### v1.3
- æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†
- å¤šç§Ÿæˆ·æ”¯æŒ
- é«˜çº§å®‰å…¨è§„åˆ™

#### v2.0
- æ•°æ®åº“æ¶æ„é‡æ„
- æ”¯æŒæ›´å¤æ‚çš„æŸ¥è¯¢
- æœºå™¨å­¦ä¹ é›†æˆ

---

**æ–‡æ¡£ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.1  
**æœ€åæ›´æ–°**: 2024-12-19  

*æœ¬æ–‡æ¡£å°†éšç€æ•°æ®åº“æ¶æ„çš„æ¼”è¿›æŒç»­æ›´æ–°ã€‚*