# API CRUD 测试脚本

这个目录包含了用于测试图片管理系统 API 的完整测试脚本。

## 文件说明

- `test-api-crud.js` - 主要的测试脚本，包含所有 CRUD 操作和数据关联测试
- `run-tests.sh` - 便捷的运行脚本
- `README.md` - 本说明文件

## 测试内容

### 1. 基础 CRUD 操作测试
- **分类 (Categories)**: 创建、读取、更新、删除
- **标签 (Tags)**: 创建、读取、更新、删除
- **提示词 (Prompts)**: 创建、读取、更新、删除
- **图片 (Images)**: 创建、读取、更新、删除

### 2. 数据关联测试
- 图片与标签的关联关系
- 图片与提示词的关联关系
- 标签与分类的关联关系
- 关联数据的完整性验证

### 3. 数据一致性测试
- 删除图片时关联数据的处理
- 删除分类/标签/提示词时的数据一致性
- 更新关联关系的正确性

### 4. 错误处理测试
- 无效数据的处理
- 不存在资源的错误响应
- 边界条件测试

## 使用方法

### 方法一：使用便捷脚本（推荐）

```bash
# 在项目根目录运行
./scripts/run-tests.sh
```

### 方法二：直接运行 Node.js 脚本

```bash
# 确保开发服务器正在运行
npm run dev

# 在另一个终端运行测试
node scripts/test-api-crud.js
```

## 前置条件

1. **Node.js 环境**: 确保已安装 Node.js
2. **开发服务器**: 测试前必须启动开发服务器
   ```bash
   npm run dev
   ```
3. **数据库连接**: 确保 Firebase/Firestore 配置正确

## 测试流程

测试脚本会按以下顺序执行：

1. **服务器连接检查** - 验证 API 服务是否可用
2. **分类 CRUD 测试** - 创建测试分类
3. **标签 CRUD 测试** - 创建测试标签（关联到分类）
4. **提示词 CRUD 测试** - 创建测试提示词
5. **图片 CRUD 测试** - 创建测试图片（关联标签和提示词）
6. **数据关联测试** - 验证关联关系和数据一致性
7. **错误处理测试** - 测试各种错误场景
8. **清理测试数据** - 删除所有测试创建的数据

## 测试结果

测试完成后会显示：
- 总测试数量
- 通过的测试数量
- 失败的测试数量
- 成功率百分比
- 详细的测试日志

## 注意事项

1. **测试数据**: 脚本会创建测试数据，测试结束后会自动清理
2. **服务器状态**: 确保开发服务器在 `http://localhost:3001` 运行
3. **网络延迟**: 脚本包含适当的延迟以避免请求过快
4. **错误处理**: 部分测试故意触发错误以验证错误处理机制

## 故障排除

### 常见问题

1. **连接失败**
   ```
   ❌ 无法连接到服务器 http://localhost:3001/api
   ```
   **解决方案**: 确保运行 `npm run dev` 启动开发服务器

2. **权限错误**
   ```
   permission denied: ./scripts/run-tests.sh
   ```
   **解决方案**: 运行 `chmod +x scripts/run-tests.sh`

3. **Node.js 未找到**
   ```
   command not found: node
   ```
   **解决方案**: 安装 Node.js

### 调试模式

如果需要更详细的调试信息，可以修改 `test-api-crud.js` 中的日志级别或添加更多日志输出。

## 扩展测试

要添加新的测试用例：

1. 在相应的测试数组中添加新的 `TestCase`
2. 实现测试逻辑
3. 确保测试数据的正确清理

示例：
```javascript
new TestCase('新测试用例', async () => {
  // 测试逻辑
  const result = await apiRequest('GET', '/some-endpoint');
  if (!result.success) {
    throw new Error('测试失败');
  }
  logInfo('测试通过');
})
```